#!/bin/sh
#/ Usage: cbk-pull [-a]
#/        cbk-pull <cloud>...
#/        cbk-pull [--version]
#/ Pull down cloud data onto the local host.
set -e

cd $(dirname "$0")/..
. share/cbk/cbk-config

clouds=""
while [ "$#" -ne 0 ]; do
    case "$1" in
        --version)
            echo "cbk version $CBK_VERSION"
            exit 0
            ;;
        -a)
            clouds="$CBK_CLOUDS"
            shift
            ;;
        github|fastmail-imap|fastmail-carddav|irclogs|pinboard|soundcloud-likes)
            clouds="$clouds $1"
            shift
            ;;
        *)
            echo "cbk: Unsupported cloud source \"$1\"" 1>&2
            echo "Supported sources: $CBK_CLOUDS" 1>&2
            exit 1
            ;;
    esac
done

for cloud in $clouds; do
    pullcommand="cbk-pull-$cloud"
    start=$(date +"%s")

    echo "at=start cloud=$cloud" 1>&2

    if $pullcommand
    then
        duration="$(($(date +'%s') - $start))"
        echo "at=finish cloud=$cloud duration=$duration" 1>&2
    else
        echo "at=error cloud=$cloud" 1>&2
    fi
done
