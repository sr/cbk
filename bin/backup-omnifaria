#!/bin/sh
# Usage: backup-omnifaria <directory>
set -e

dir="$1"

test -d "$dir" || {
    echo >&2 "$dir directory not found"
    exit 1
}
cd "$dir"

repo_check="$(git rev-parse --show-toplevel 2>/dev/null)"
if test $? != 0 || test "$repo_check" != "$dir";
then
    git init>/dev/null
fi

pages_count="$(
    curl -s http://omnifaria.com |
    grep -o -E 'data-total-pages="\d+"' |
    cut -d"=" -f2 |
    cut -d"\"" -f2
)"
ua="User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4)"
ua="$ua AppleWebKit/537.77.4 (KHTML, like Gecko) Version/7.0.5 Safari/537.77.4"

for i in $(seq 1 $pages_count); do
    wget -q \
        --header="$ua" \
        --limit-rate=500k \
        --random-wait \
        --wait=0.5 \
        --page-requisites \
        --span-hosts \
        --convert-links \
        --timestamping \
        --adjust-extension \
        omnifaria.com/page/$i

    ruby -Ku -pi \
        -e '$_.gsub!(/http:\/\/omnifaria\.com\/page\/(\d+)"/, "\\1.html\"")' \
        omnifaria.com/page/$i.html
done

# commit changes
test -n "$(git status --porcelain)" && {
    message="synced omnifaria.com with $(basename "$0")"
    git add . >/dev/null
    git commit -m "$message">/dev/null
}
