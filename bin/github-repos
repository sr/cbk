#!/bin/sh
## Usage: github-repos <user> <token>
##
## Writes the HTTPS clone URLs of all GitHub repositories which are accessible
## by the given GitHub user and token to stdout.
##
## Inspired by https://github.com/mrtazz/bin/blob/master/github_repo_list.sh
set -e

user="$1"
token="$2"

# usage and help
if test $# -eq 0 || test -z "$user" || test -z "$token"
then
    cat "$0" | grep '^##' | cut -c4- 1>&2
    exit 2
fi

# construct the api url for grabbing all repos
authparam="access_token=$token"
apiurl="https://api.github.com"
authurl="$apiurl/user?$authparam"
reposurl="$apiurl/users/$user/repos?$authparam"

# make sure we're authenticated
if ! headers "$authurl" | grep -q "Status: 200 OK"
then
    echo >&2 "authentication failed"
    exit 1
fi

# grab the last page number
last_page=$(
    headers "$reposurl" |
    grep Link: |
    cut -d"," -f2 |
    cut -d"&" -f2 |
    cut -d"=" -f2 |
    cut -d">" -f1
)
if test -z "$last_page"
then
    echo >&2 "failed to get the last page number."
    exit 1
fi

# iterate through all pages and write the repos' clones urls to stdout
for i in $(seq 1 $last_page)
do
    curl -s -f "$reposurl&page=$i" |
        grep clone_url |
        cut -d" " -f6 |
        sed -e "s/[\",]//g" |
        tr ' ' '\n'
done
