#!/bin/sh
set -e
cloud="$1"
repo="$2"
log="$3"

# default values
lastrun="never"
status="-"
lastline=""

# for github use the mtime of the log to get the last run time
if test "$cloud" = "github" && test -f "$log"
then
    lastrun="$(date -r "$(stat -f "%m" "$log")" +"%Y-%m-%d")"
# otherwise use the repo's HEAD commit
elif test -d "$repo/.git"
then
    lastrun="$(
    git --git-dir="${repo}/.git" \
        log --max-count=1 --format="%ad" --date=relative
    )"
fi

# grab the last line of the log when present
test -f "$log" && {
    lastline="$(tail -1 "$log" | cut -c1-70)"
}

# get the exit status of the corresponding launchd agent
if launchctl list | grep -q "backup.${1}"
then status="$(launchctl list | grep backup.${1} | cut -f2)"
fi

# write status info to stdout
printf "%-10s%-15s%-5s%s\n" "$cloud" "$lastrun" "$status" "$lastline"
